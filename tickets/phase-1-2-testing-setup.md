# Phase 1, Ticket 2: Testing Framework Setup

**Priority**: High  
**Estimated Time**: 1-2 hours  
**Prerequisites**: Completed Phase 1, Ticket 1  

## Objective

Configure RSpec testing framework with supporting gems and establish testing conventions for the application.

## Acceptance Criteria

- [ ] RSpec configured as the primary testing framework
- [ ] FactoryBot set up for test data generation
- [ ] Shoulda matchers configured for cleaner model tests
- [ ] Capybara configured for integration tests
- [ ] Test database properly configured
- [ ] Basic test structure created
- [ ] All tests pass (even if there are none initially)

## Technical Requirements

### 1. Install and Configure RSpec
```bash
bundle exec rails generate rspec:install
```

### 2. Configure RSpec
Update `spec/rails_helper.rb`:

```ruby
# Add to the top after other requires
require 'shoulda/matchers'
require 'capybara/rspec'

# Add this configuration block at the bottom
Shoulda::Matchers.configure do |config|
  config.integrate do |with|
    with.test_framework :rspec
    with.library :rails
  end
end

# Configure RSpec
RSpec.configure do |config|
  # Include FactoryBot methods
  config.include FactoryBot::Syntax::Methods
  
  # Use database cleaner instead of transactional fixtures
  config.use_transactional_fixtures = false
  
  # Clean database before each test
  config.before(:suite) do
    DatabaseCleaner.strategy = :transaction
    DatabaseCleaner.clean_with(:truncation)
  end

  config.around(:each) do |example|
    DatabaseCleaner.cleaning do
      example.run
    end
  end
end
```

### 3. Configure Database Cleaner
Add to Gemfile in test group:
```ruby
gem 'database_cleaner-active_record'
```

Update `spec/rails_helper.rb` to require it:
```ruby
require 'database_cleaner/active_record'
```

### 4. Create Basic Directory Structure
```
spec/
├── factories/
├── models/
├── controllers/
├── features/
├── jobs/
├── mailers/
└── support/
```

### 5. Configure Capybara
Update `spec/rails_helper.rb`:
```ruby
# Configure Capybara for integration tests
Capybara.configure do |config|
  config.default_driver = :rack_test
  config.javascript_driver = :selenium_chrome_headless
end
```

### 6. Create Support Files
Create `spec/support/factory_bot.rb`:
```ruby
RSpec.configure do |config|
  config.include FactoryBot::Syntax::Methods
end
```

Create `spec/support/database_cleaner.rb`:
```ruby
RSpec.configure do |config|
  config.before(:suite) do
    DatabaseCleaner.clean_with(:truncation)
  end

  config.before(:each) do
    DatabaseCleaner.strategy = :transaction
  end

  config.before(:each, js: true) do
    DatabaseCleaner.strategy = :truncation
  end

  config.before(:each) do
    DatabaseCleaner.start
  end

  config.append_after(:each) do
    DatabaseCleaner.clean
  end
end
```

### 7. Update Rails Helper
Update `spec/rails_helper.rb` to load support files:
```ruby
# Load support files
Dir[Rails.root.join('spec', 'support', '**', '*.rb')].sort.each { |f| require f }
```

## Testing Requirements

- [ ] `bundle exec rspec` runs without errors
- [ ] Test database is created and configured
- [ ] FactoryBot loads without issues
- [ ] Shoulda matchers work correctly
- [ ] Capybara integration tests can run

## Files to Create/Modify

- `spec/rails_helper.rb` - Main RSpec configuration
- `spec/spec_helper.rb` - Generated by RSpec installer
- `spec/support/factory_bot.rb` - FactoryBot configuration
- `spec/support/database_cleaner.rb` - Database cleaner setup
- `Gemfile` - Add database_cleaner gem
- `.rspec` - RSpec options file

## Sample Test Files

Create `spec/models/.gitkeep` to maintain directory structure.

Create `spec/features/.gitkeep` for future integration tests.

## Deliverables

1. Fully configured RSpec testing environment
2. FactoryBot ready for test data generation
3. Capybara configured for integration testing
4. Clean test database setup
5. Support files properly organized

## Notes for Junior Developer

- RSpec uses `describe` and `it` blocks to organize tests
- FactoryBot replaces Rails fixtures with more flexible test data
- Shoulda matchers provide convenient Rails-specific test methods
- Database cleaner ensures each test starts with a clean database
- Capybara allows testing user interactions through the browser

## Validation Steps

1. Run test suite: `bundle exec rspec`
2. Check RSpec version: `bundle exec rspec --version`
3. Verify database cleaner: Tests should not leave data behind
4. Check factory bot: `FactoryBot.lint` should pass (when factories exist)

## Common Issues and Solutions

- **PostgreSQL test database errors**: Ensure test database exists and user has permissions
- **Database cleaner conflicts**: Make sure `use_transactional_fixtures = false`
- **FactoryBot not loading**: Check that support files are properly required

## Next Steps

After completing this ticket, you'll move to Phase 1, Ticket 3: Development Tools Setup.